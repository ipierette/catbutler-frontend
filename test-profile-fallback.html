<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Fallback Profile</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #1a1a1a; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #2d5a27; border-left: 5px solid #4CAF50; }
        .error { background: #5a2727; border-left: 5px solid #f44336; }
        .info { background: #27475a; border-left: 5px solid #2196F3; }
        .warning { background: #5a5427; border-left: 5px solid #ff9800; }
        button { 
            background: #4CAF50; color: white; border: none; 
            padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; 
        }
        button:hover { background: #45a049; }
        .clear-btn { background: #f44336; }
        .clear-btn:hover { background: #da190b; }
        pre { background: #333; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üê± CatButler - Teste Fallback Profile</h1>
        <div id="results"></div>

        <div style="margin: 20px 0;">
            <button onclick="testProfileUpdate()">Testar Update Profile</button>
            <button onclick="testProfileLoad()">Testar Load Profile</button>
            <button onclick="viewLocalStorage()">Ver localStorage</button>
            <button onclick="clearLocalStorage()" class="clear-btn">Limpar localStorage</button>
        </div>

        <div id="storage-display"></div>
    </div>

    <script>
        const results = document.getElementById('results');
        const storageDisplay = document.getElementById('storage-display');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        // Simular as fun√ß√µes do CatButler
        function updateUserProfile(profileData) {
            return new Promise((resolve, reject) => {
                try {
                    log('Tentando salvar profile...', 'info');
                    
                    // Simular erro da tabela ausente (como no Supabase)
                    const simulateSupabaseError = Math.random() > 0.5;
                    
                    if (simulateSupabaseError) {
                        log('Simulando erro Supabase (tabela profiles n√£o encontrada)', 'warning');
                        throw new Error('Could not find the table "public.profiles" in the schema cache');
                    }
                    
                    log('Salvando no localStorage como fallback...', 'warning');
                    const userData = {
                        ...profileData,
                        updatedAt: new Date().toISOString(),
                        source: 'localStorage_fallback'
                    };
                    
                    localStorage.setItem('catbutler_user_profile', JSON.stringify(userData));
                    log('Profile salvo com sucesso no localStorage!', 'success');
                    resolve(userData);
                    
                } catch (error) {
                    log(`Erro ao salvar profile: ${error.message}`, 'error');
                    reject(error);
                }
            });
        }

        function getUserProfile() {
            return new Promise((resolve) => {
                try {
                    log('Tentando carregar profile...', 'info');
                    
                    const stored = localStorage.getItem('catbutler_user_profile');
                    if (stored) {
                        const profile = JSON.parse(stored);
                        log('Profile carregado do localStorage!', 'success');
                        resolve(profile);
                    } else {
                        log('Nenhum profile encontrado', 'warning');
                        resolve(null);
                    }
                } catch (error) {
                    log(`Erro ao carregar profile: ${error.message}`, 'error');
                    resolve(null);
                }
            });
        }

        async function testProfileUpdate() {
            const testData = {
                name: `Usu√°rio Teste ${Math.floor(Math.random() * 1000)}`,
                avatar: `avatar-${Math.floor(Math.random() * 10)}.png`,
                preferences: {
                    theme: 'dark',
                    notifications: true
                }
            };

            try {
                log(`Testando update com dados: ${JSON.stringify(testData)}`, 'info');
                const result = await updateUserProfile(testData);
                log(`Update realizado: ${JSON.stringify(result)}`, 'success');
            } catch (error) {
                log(`Erro no update: ${error.message}`, 'error');
            }
        }

        async function testProfileLoad() {
            try {
                const profile = await getUserProfile();
                if (profile) {
                    log(`Profile carregado: ${JSON.stringify(profile)}`, 'success');
                } else {
                    log('Nenhum profile encontrado', 'warning');
                }
            } catch (error) {
                log(`Erro no load: ${error.message}`, 'error');
            }
        }

        function viewLocalStorage() {
            const profile = localStorage.getItem('catbutler_user_profile');
            if (profile) {
                storageDisplay.innerHTML = `
                    <h3>localStorage Data:</h3>
                    <pre>${JSON.stringify(JSON.parse(profile), null, 2)}</pre>
                `;
                log('localStorage exibido abaixo', 'info');
            } else {
                storageDisplay.innerHTML = '<p>Nenhum dado encontrado no localStorage</p>';
                log('localStorage est√° vazio', 'warning');
            }
        }

        function clearLocalStorage() {
            localStorage.removeItem('catbutler_user_profile');
            storageDisplay.innerHTML = '';
            log('localStorage limpo!', 'success');
        }

        // Auto-inicializa√ß√£o
        log('Sistema de teste de fallback iniciado', 'success');
        log('Este teste simula o comportamento do CatButler com a tabela profiles ausente', 'info');
    </script>
</body>
</html>